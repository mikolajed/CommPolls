<!DOCTYPE html>
<html>
<head>
    <title>CommPolls</title>
</head>
<body>
    {% load static %}

    {% if user.is_authenticated %}
        <!-- Header -->
        <div>
            {% if user.profile.avatar %}
                <img src="{{ user.profile.avatar.url }}" alt="Avatar" style="width:50px;height:50px;border-radius:50%;">
            {% else %}
                <span style="font-size:40px;">ðŸ‘¤</span>
            {% endif %}
            <strong>Hello, {{ user.username }}!</strong>
        </div>

        <!-- Navigation Bar -->
        <p>
            <a href="{% url 'comm_polls:home' %}">Home</a> |
            <a href="{% url 'comm_polls:polls' %}">Polls</a> |
            <a href="{% url 'comm_polls:votes' %}">My Votes</a> |
            <a href="{% url 'comm_polls:create_poll' %}">Create Poll</a> |
            <a href="{% url 'comm_polls:account_settings' %}">Settings</a> |
            <a href="{% url 'logout' %}">Logout</a>
        </p>

        <hr>

        <!-- Filter Form -->
        <h2>Filter Polls</h2>
        <form method="get">
            <label for="creator">Creator:</label>
            <select name="creator" id="creator">
                <option value="">All</option>
                {% for u in users %}
                    <option value="{{ u.id }}" {% if selected_creator|stringformat:"s" == u.id|stringformat:"s" %}selected="selected"{% endif %}>{{ u.username }}</option>
                {% endfor %}
            </select>

            <label for="start_date">Start Date:</label>
            <input type="date" name="start_date" id="start_date" value="{{ filters.start_date }}">

            <label for="end_date">End Date:</label>
            <input type="date" name="end_date" id="end_date" value="{{ filters.end_date }}">

            <label for="voted_status">My Votes:</label>
            <select name="voted_status" id="voted_status">
                <option value="">All</option>
                <option value="voted" {% if filters.voted_status == 'voted' %}selected{% endif %}>Voted</option>
                <option value="not_voted" {% if filters.voted_status == 'not_voted' %}selected{% endif %}>Not Voted</option>
            </select>

            <label for="poll_status">Status:</label>
            <select name="poll_status" id="poll_status">
                <option value="">All</option>
                <option value="ongoing" {% if filters.poll_status == 'ongoing' %}selected{% endif %}>Ongoing</option>
                <option value="ended" {% if filters.poll_status == 'ended' %}selected{% endif %}>Ended</option>
                <option value="not_started" {% if filters.poll_status == 'not_started' %}selected{% endif %}>Not Started</option>
            </select>

            <button type="submit">Filter</button>
            <a href="{% url 'comm_polls:home' %}">Clear</a>
        </form>

        <hr>

        <!-- Poll List -->
        <h2>All Polls</h2>
        {% if polls %}
            <ul>
                {% for poll in polls %}
                    <li>
                        <div {% if poll.is_suspended %}style="opacity: 0.6;"{% endif %}>
                            <strong>
                                {% if poll.has_ended %}
                                    <a href="{% url 'comm_polls:results' poll.id %}">{{ poll.name }}</a>
                                {% else %}
                                    <a href="{% url 'comm_polls:vote' poll.id %}">{{ poll.name }}</a>
                                {% endif %}
                            </strong> 
                            {% if poll.is_suspended %}
                                <span style="color:red;">(Suspended)</span>
                            {% endif %}
                            <p>Created by: {{ poll.created_by.username }}</p>
                            <p>Starts: {{ poll.start_date }} | Ends: {{ poll.end_date }}</p>

                            {% if poll.has_ended %}
                                <p><strong>Results:</strong></p>
                                <ul style="font-size: 0.9em; margin-top: 5px;">
                                    {% for choice in poll.choices.all %}
                                        <li>{{ choice.name }}: {{ choice.votes_count }} vote{{ choice.votes_count|pluralize }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>

                        {% if user.is_authenticated and perms.comm_polls.can_suspend_poll %}
                            <form action="{% url 'comm_polls:suspend_poll' poll.id %}" method="post" style="display:inline; margin-left: 10px;">
                                {% csrf_token %}
                                <button type="submit">
                                    {% if poll.is_suspended %}Unsuspend{% else %}Suspend{% endif %}
                                </button>
                            </form>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No polls match your filter criteria.</p>
        {% endif %}

    {% else %}
        <!-- Guest View -->
        <h1>Welcome to CommPolls!</h1>
        <p>
            <a href="{% url 'comm_polls:signup' %}">Sign up</a> or 
            <a href="{% url 'login' %}">Login</a>
        </p>
    {% endif %}
</body>
</html>
